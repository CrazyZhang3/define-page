name: Release

permissions:
  contents: write

on:
  # å½“å¯¹åˆ†æ”¯masterè¿›è¡Œpushæ“ä½œçš„æ—¶å€™,è§¦å‘è¯¥æ¡å·¥ä½œæµ
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  check:
    name: æ£€æŸ¥ç‰ˆæœ¬å·
    runs-on: ubuntu-latest
    outputs:
      current_tag: v${{ steps.package_json.outputs.version }}
      previous_tag: ${{ steps.version_tag.outputs.latest_tag }}
      created: ${{ steps.create_tag.outputs.created }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: é…ç½® Node.js
        uses: actions/setup-node@v4

      - name: è¯»å– package.json ç‰ˆæœ¬å·
        id: package_json
        run: |
          version=$(node -p "require('./package.json').version")
          echo "Package version is: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: è·å–æ‰€æœ‰æ ‡ç­¾
        run: |
          git fetch --prune --unshallow

      - name: è·å–æœ€åçš„ tag
        id: version_tag
        run: |
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          if [ -z "$latest_tag" ] || ! [[ "$latest_tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "å½“å‰ç‰ˆæœ¬æ ‡ç­¾éæ³•ï¼š$latest_tag"
            echo "latest_version=" >> $GITHUB_OUTPUT
          else
            echo "latest_version=$latest_tag" >> $GITHUB_OUTPUT # Remove 'v' prefix if present
          fi

      - name: å¯¹æ¯”ã€åˆ›å»ºç‰ˆæœ¬tag
        id: create_tag
        run: |
          package_version=v${{ steps.package_json.outputs.version }}
          tag_tag=${{ steps.version_tag.outputs.latest_tag }}
          tag_version=${{ steps.version_tag.outputs.latest_version }}
          if [ "$package_version" == "$tag_version" ]; then
            echo "Versions match: $package_version == $tag_version"
            echo "created=false" >> $GITHUB_OUTPUT
          else
            echo "Versions do not match: $package_version != $tag_tag"
            echo "Creating new tag: $package_version"
            git tag "$package_version"
            git push origin "$package_version"
            echo "created=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    name: æ„å»ºå¹¶å‘ç‰ˆ
    needs: check
    if: needs.check.outputs.created == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–æ‰€æœ‰æ ‡ç­¾
        run: |
          git fetch --prune --unshallow

      - name: æå–å¹¶åˆ†ç±»æäº¤æ¶ˆæ¯
        id: extract_commit_messages
        run: |
          set -e

          current_tag="${{ needs.check.outputs.current_tag }}"
          previous_tag="${{ needs.check.outputs.previous_tag }}"
          echo "Current Tag: $current_tag"
          echo "Previous Tag: $previous_tag"

          if [ -z "$previous_tag" ]; then
            commit_messages=$(git log --pretty=format:"%s - by @%an (%h)" "$current_tag" | grep -E 'feat|fix|docs|perf')
          else
            commit_messages=$(git log --pretty=format:"%s - by @%an (%h)" "$previous_tag".."$current_tag" | grep -E 'feat|fix|docs|perf')
          fi

          # è½¬ä¹‰ ` å­—ç¬¦
          commit_messages=$(echo "$commit_messages" | sed 's/`/\\\`/g')

          # feat_messages=$(echo "$commit_messages" | grep 'feat' || true)
          # fix_messages=$(echo "$commit_messages" | grep 'fix' || true)
          # docs_messages=$(echo "$commit_messages" | grep 'docs' || true)
          # perf_messages=$(echo "$commit_messages" | grep 'perf' || true)

          # feat_messages=("${feat_messages[@]//\`/\\\`}")
          # fix_messages=("${fix_messages[@]//\`/\\\`}")
          # docs_messages=("${docs_messages[@]//\`/\\\`}")
          # perf_messages=("${perf_messages[@]//\`/\\\`}")

          # echo "feat_messages=(${feat_messages[@]})" >> $GITHUB_OUTPUT
          # echo "fix_messages=(${fix_messages[@]})" >> $GITHUB_OUTPUT
          # echo "docs_messages=(${docs_messages[@]})" >> $GITHUB_OUTPUT
          # echo "perf_messages=(${perf_messages[@]})" >> $GITHUB_OUTPUT

          {
            echo 'feat_messages<<EOF'
            echo "$commit_messages" | grep 'feat' || true
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          {
            echo 'fix_messages<<EOF'
            echo "$commit_messages" | grep 'fix' || true
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          {
            echo 'docs_messages<<EOF'
            echo "$commit_messages" | grep 'docs' || true
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          {
            echo 'perf_messages<<EOF'
            echo "$commit_messages" | grep 'perf' || true
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: è·å–å½“å‰åˆ†æ”¯å
        id: get_branch_name
        run: |
          branch_name=$(git rev-parse --abbrev-ref HEAD)
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT

      - name: å‘ç‰ˆè¯¦æƒ…
        id: generate_release_notes
        run: |
          # æå–æäº¤æ¶ˆæ¯åˆ†ç±»
          feat_messages=("${{ steps.extract_commit_messages.outputs.feat_messages }}")
          fix_messages=("${{ steps.extract_commit_messages.outputs.fix_messages }}")
          docs_messages=("${{ steps.extract_commit_messages.outputs.docs_messages }}")
          perf_messages=("${{ steps.extract_commit_messages.outputs.perf_messages }}")

          release_notes=""

          if [[ -n "$feat_messages" ]]; then
            release_notes="$release_notes\n### ğŸš€ Features æ–°åŠŸèƒ½:  \n"
            while IFS= read -r message; do
              release_notes="$release_notes\n- $message"
            done <<< "$feat_messages"
          fi

          if [[ -n "$fix_messages" ]]; then
            release_notes="$release_notes\n### ğŸ©¹ Fixes ç¼ºé™·ä¿®å¤:  \n"
            while IFS= read -r message; do
              release_notes="$release_notes\n- $message"
            done <<< "$fix_messages"
          fi

          if [[ -n "$docs_messages" ]]; then
            release_notes="$release_notes\n### ğŸ“– Documentation æ–‡æ¡£:  \n"
            while IFS= read -r message; do
              release_notes="$release_notes\n- $message"
            done <<< "$docs_messages"
          fi

          if [[ -n "$perf_messages" ]]; then
            release_notes="$release_notes\n### ğŸ”¥ Performance æ€§èƒ½ä¼˜åŒ–:  \n"
            while IFS= read -r message; do
              release_notes="$release_notes\n- $message"
            done <<< "$perf_messages"
          fi

          # è½¬ä¹‰ ` å­—ç¬¦
          release_notes=$(echo "$release_notes" | sed 's/`/\\\`/g')
          echo "release_notes=$release_notes" >> $GITHUB_OUTPUT

      - name: å†™å…¥ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜åˆ° changelog.md
        run: |
          echo -e "${{ steps.generate_release_notes.outputs.release_notes }}" > changelog.md
          cat changelog.md

      - name: å¼•ç”¨ changelog.md åˆ›å»ºå‘ç‰ˆ
        id: release_tag
        uses: ncipollo/release-action@v1.14.0
        with:
          bodyFile: changelog.md
          tag: ${{ needs.check.outputs.current_tag }}

  publish:
    name: å‘å¸ƒåˆ° NPM
    needs: [check, release]
    if: needs.check.outputs.created == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      actions: write
      pull-requests: write
      statuses: write
      contents: write
      issues: write
      security-events: write
      pages: read

    environment: npm
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£… PNPM
        uses: pnpm/action-setup@v3.0.0
        with:
          version: 8
          run_install: false

      - name: é…ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: pnpm

      - name: å®‰è£…ä¾èµ–
        run: pnpm i --frozen-lockfile

      - name: å‘å¸ƒåˆ° NPM
        run: pnpm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
